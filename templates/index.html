<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Oriented Data Cleaning</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index_css.css') }}">
</head>

<body>
    <div class="container">
        <h1>Query Oriented Data Cleaning</h1>
        <div id="question-container"></div>
        <p id="question-count"></p>
        <button id="index-yes-btn" class="action-btn">Yes</button>
        <button id="index-no-btn" class="action-btn">No</button>
        <button id="index-back-btn" class="action-btn">Back</button>
        <button id="index-find-missing-btn" class="action-btn" onclick="window.location.href='/find_missing_values'">Find Missing Data Values</button>
        <button id="find-missing-yes-btn" class="action-btn">Yes</button>
        <button id="find-missing-no-btn" class="action-btn">No</button>
        <button id="find-missing-back-btn" class="action-btn">Back</button>
        <button id="show-flagged-values-btn" class="action-btn">Show Flagged Values Question</button>
        <button id="show-flagged-values-no-btn" class="action-btn">Next Question</button>
        <button id="show-flagged-values-back-btn" class="action-btn">Back</button>
        <button id="submit-answer-btn">Submit Answer</button>
    </div>
    <div id="queryModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">&times;</span>
            <label>Provide an answer to the current question:</label>
            <input type="text" id="user-query-input" />
            <button id="submit-query-btn">Submit Query</button>
        </div>
    </div>
    <script>
        let displayedRowIdMissing; // Variable to store the displayed row ID for missing data questions
        document.addEventListener('DOMContentLoaded', function () {
        const inputField = document.getElementById('user-query-input');
        const submitQueryBtn = document.getElementById('submit-query-btn');

        // Function to update the cursor style of the submit button
    function updateSubmitButtonCursor() {
        if (inputField.value.trim() === '') {
            submitQueryBtn.classList.add('cursor-not-allowed');
            submitQueryBtn.disabled = true; // Optionally disable the button
        } else {
            submitQueryBtn.classList.remove('cursor-not-allowed');
            submitQueryBtn.disabled = false; // Optionally enable the button
        }
    }

    // Initial check in case there's already text in the input field when the page loads
    updateSubmitButtonCursor();

    // Event listener to check input field's value on keyup
    inputField.addEventListener('keyup', function () {
        updateSubmitButtonCursor();
    });

    // Prevent the form from submitting if the input field is empty and the button is clicked
    submitQueryBtn.addEventListener('click', function (event) {
        if (inputField.value.trim() === '') {
            event.preventDefault(); // Stop the form from submitting
            alert('Please enter a query before submitting.'); // Optional: Display a message
        }
    });

        var preRenderedQuestions = {{ pre_rendered_questions | safe }};
        var generatedQueries = [];

        // Get the current URL
        var currentUrl = window.location.href;

        // Select buttons based on the current URL
        const yesBtn = document.getElementById('index-yes-btn');
        const noBtn = document.getElementById('index-no-btn');
        const backBtn = document.getElementById('index-back-btn');
        const findMissingBtn = document.getElementById('index-find-missing-btn');

        // Select buttons for the find_missing_values page
        const findMissingYesBtn = document.getElementById('find-missing-yes-btn');
        const findMissingNoBtn = document.getElementById('find-missing-no-btn');
        const findMissingBackBtn = document.getElementById('find-missing-back-btn');

        // Select buttons for the show_flagged_values page
        const flaggedValue = document.getElementById('show-flagged-values-btn');
        const flaggedValuesnoBtn = document.getElementById('show-flagged-values-no-btn');
        const flaggedValuesbackBtn = document.getElementById('show-flagged-values-back-btn');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');

        // Check if on the find_missing_values page
        if (currentUrl.includes('/find_missing_values')) {
            // Hide buttons on the index page
            yesBtn.style.display = 'none';
            noBtn.style.display = 'none';
            backBtn.style.display = 'none';
            findMissingBtn.style.display = 'none';
            submitAnswerBtn.style.display = 'none';

            // Show buttons on the find_missing_values page
            findMissingYesBtn.style.display = 'inline-block';
            findMissingNoBtn.style.display = 'inline-block';
            findMissingBackBtn.style.display = 'inline-block';
            flaggedValuesnoBtn.style.display = 'none';
            flaggedValuesbackBtn.style.display = 'none';

        } else {
            // Show buttons on the index page
            yesBtn.style.display = 'inline-block';
            noBtn.style.display = 'inline-block';
            backBtn.style.display = 'inline-block';
            findMissingBtn.style.display = 'inline-block';

            // Hide buttons on the find_missing_values page
            findMissingYesBtn.style.display = 'none';
            findMissingNoBtn.style.display = 'none';
            findMissingBackBtn.style.display = 'none';
            submitAnswerBtn.style.display = 'none';
            flaggedValuesnoBtn.style.display = 'none';
            flaggedValuesbackBtn.style.display = 'none';
        }

        console.log('Pre-rendered questions:', preRenderedQuestions);

        let currentQuestionIndex = 0;
        let totalQuestions = preRenderedQuestions.length;

        const questionContainer = document.getElementById('question-container');
        const questionCount = document.getElementById('question-count');

        let displayedRowId; // Variable to store the displayed row ID
        
        function displayQuestion() {
    console.log('Executing displayQuestion');

    if (currentQuestionIndex < totalQuestions) {
        const currentQuestion = preRenderedQuestions[currentQuestionIndex];
        console.log('Current question object:', currentQuestion);

        // Check if we are on the "find missing values" page and set displayedRowIdMissing
        if (currentUrl.includes('/find_missing_values')) {
            // Check if currentQuestion has a data property and a row_id within it
            if (currentQuestion.data && 'row_id' in currentQuestion.data) {
                displayedRowIdMissing = currentQuestion.data.row_id;
                console.log(`Currently Displayed Row ID (Missing Data): ${displayedRowIdMissing}`);
            } else {
                console.error('Row ID missing in question data for missing values page');
            }
        } else {
            // For other pages, use the existing method to set displayedRowId
            displayedRowId = currentQuestion.row_id;
            console.log(`Currently Displayed Row ID: ${displayedRowId}`);
        }

        // Determine whether we're dealing with a flagged value question or not
        if (currentQuestion.hasOwnProperty('question')) {
            // For flagged value questions
            questionContainer.innerHTML = `<label>${formatQuestionText(currentQuestion.question)}</label>`;
        } else {
            // For other question types (assuming 'message' field contains the question text)
            questionContainer.innerHTML = `<label>${formatQuestionText(currentQuestion.message)}</label>`;
        }

        // Add tooltip for rule violation text if it exists
        if (currentQuestion.hasOwnProperty('rule_violation') && currentQuestion.rule_violation) {
            const ruleViolationText = currentQuestion.rule_violation;
            const tooltip = document.createElement('img');
            tooltip.src = 'http://localhost/project/templates/info.png';
            tooltip.className = 'tooltip-icon';
            tooltip.alt = 'Info';
            tooltip.title = ruleViolationText; // Tooltip text
            const questionLabel = questionContainer.querySelector('label');
            questionLabel.appendChild(tooltip);
        }

        updateQuestionCount();
        // Ensure the submit button cursor and disabled state are updated for the new question
        updateSubmitButtonCursor();
    } else {
        alert('All questions answered. Submitting form...');
    }
}

            function formatQuestionText(questionText) {
                return questionText.replace(/''/g, '_______');
            }

            function updateQuestionCount() {
    // Count the number of unanswered questions
    const unansweredQuestions = preRenderedQuestions.filter(question => !question.answered).length;

    // Update the question count display. The current question number should be the index of the current question
    // among the unanswered questions + 1, because index is 0-based and we want to display a 1-based count.
    const currentQuestionNumber = preRenderedQuestions.slice(0, currentQuestionIndex + 1).filter(question => !question.answered).length;

    questionCount.textContent = `Question ${currentQuestionNumber} of ${unansweredQuestions}`;
}


            function answerYes_index() {
        const modal = document.getElementById('queryModal');
        modal.style.display = 'block';

        
        submitQueryBtn.addEventListener('click', function () {
            const userQueryInput = document.getElementById('user-query-input');
            const userQuery = userQueryInput.value.trim();

            if (userQuery !== '') {
                // Extract question details from the current question
                const currentQuestion = preRenderedQuestions[currentQuestionIndex];

                // Send the user-provided answer to the server
                updateDatabaseWithAnswer(userQuery, currentQuestion);

                // Clear the input field
                userQueryInput.value = '';

                // Close the modal
                modal.style.display = 'none';
            } else {
                alert('Please provide a valid query.');
            }
        });

        const closeModalBtn = document.getElementById('closeModal');
        closeModalBtn.addEventListener('click', function () {
            modal.style.display = 'none';
        });
    }

function findMissingPageAnswerYes() {
    const modal = document.getElementById('queryModal');
    modal.style.display = 'block';
        submitQueryBtn.addEventListener('click', function () {
        const userQueryInput = document.getElementById('user-query-input');
        const userQuery = userQueryInput.value.trim();

        if (userQuery !== '') {
            const currentQuestion = preRenderedQuestions[currentQuestionIndex];
            const questionDetails = currentQuestion.name.split('_');
            const mainColumn = questionDetails[2]; 
            const relatedColumn = questionDetails[3]; 

            const dataToSend = {
                rowId: displayedRowIdMissing, 
                mainColumn: mainColumn, 
                relatedColumn: relatedColumn, 
                answer: userQuery
            };

            // Debugging: Log the data being sent
            console.log(`Sending data: ${JSON.stringify(dataToSend)}`);

            fetch('/process_answers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // Mark the current question as answered
                    preRenderedQuestions[currentQuestionIndex].answered = true;

                    // Find the next unanswered question
                    const nextUnansweredIndex = preRenderedQuestions.findIndex((question, index) => index > currentQuestionIndex && !question.answered);
                console.log('Response from server:', data);
                if (nextUnansweredIndex !== -1) {
                        currentQuestionIndex = nextUnansweredIndex;
                        displayQuestion();
                } else {
                    // Enable the button and display an alert
                    submitQueryBtn.disabled = false;
                    alert('All questions answered. Submitting form...');
                }
            } else {
                    // Handle error or unsuccessful response
                    console.error('Error submitting answer:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Enable the button in case of an error
                submitQueryBtn.disabled = false;
            });

            // Clear the input field and close the modal
            userQueryInput.value = '';
            modal.style.display = 'none';
        } else {
            submitQueryBtn.disabled = false;
            
        }
    });

    const closeModalBtn = document.getElementById('closeModal');
    closeModalBtn.addEventListener('click', function () {
        modal.style.display = 'none';
    });
}
            // Function to update the database with the provided answer
            function updateDatabaseWithAnswer(userQuery, currentQuestion) {
                const [_, rowId, mainColumn, relatedColumn] = currentQuestion.name.split('_');

                // Dynamically extract the relatedColumn from the question text
                const questionText = currentQuestion.message;
                const relatedColumnMatch = questionText.match(/The (.*?):/);
                const dynamicRelatedColumn = relatedColumnMatch ? relatedColumnMatch[1].trim() : null;

                const data = {
                    rowId: rowId,
                    mainColumn: mainColumn,
                    relatedColumn: dynamicRelatedColumn, // Use the dynamically extracted relatedColumn
                    answer: userQuery,
                };

                // Send a POST request to the server to process the answer and update the database
                fetch('/process_answers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);

                    // Increment the currentQuestionIndex and display the next question
                    currentQuestionIndex++;
                    if (currentQuestionIndex < totalQuestions) {
                        displayQuestion();
                    } else {
                        alert('All questions answered. Submitting form...');
                    }
                })
                .catch(error => console.error(error));
}

function answerNo_index() {
    const currentQuestion = preRenderedQuestions[currentQuestionIndex];

    // Send a POST request to the server to log the current row ID
    fetch('/log_current_row_id', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ row_id: currentQuestion.row_id }),  // Pass the current question's row_id
    })
    .then(response => response.json())
    .then(data => {
        // Move to the next question
        currentQuestionIndex++;

        // Check if there are more questions before displaying
        if (currentQuestionIndex < totalQuestions) {
            displayQuestion();
        } else {
            alert('All questions answered. Submitting form...');
        }
    })
    .catch(error => console.error(error));
}

function findMissingPageAnswerNo() {
    currentQuestionIndex++;
    if (currentQuestionIndex < totalQuestions) {
        displayQuestion();
        console.log(`Missing Page Answer No : ${displayedRowIdMissing}`);
    } else {
        alert('All questions answered. Submitting form...');
    }
}

            function goBack_index() {
                    currentQuestionIndex--;
                    if (currentQuestionIndex >= 0) {
                        displayQuestion();
                    } else {
                        alert('No more previous questions.');
                        currentQuestionIndex = 0;
                    }
                    
                }
                
                function findMissingPageGoBack() {
    // Decrement currentQuestionIndex to start looking for the previous unanswered question
    currentQuestionIndex--;

    // Loop backwards through the questions to find the first unanswered one
    while (currentQuestionIndex >= 0 && preRenderedQuestions[currentQuestionIndex].answered) {
        currentQuestionIndex--;
    }

    // Check if an unanswered question was found
    if (currentQuestionIndex >= 0) {
        displayQuestion(); // Display the previous unanswered question
    } else {
        // If no unanswered question was found (i.e., we've reached the beginning), 
        // reset currentQuestionIndex and inform the user
        currentQuestionIndex = 0; // Reset to the first question in the array
        alert('No more previous questions.');
    }
}
                function findMissingValues() {
                const filteredMissingQuestions = preRenderedQuestions.filter(question => {
                    const mainColumn = question.message.split("'")[1];
                    const mainColumnValue = row[mainColumn];
                    return mainColumnValue === '';
                });

                console.log('Filtered Missing Questions:', filteredMissingQuestions);

                totalQuestions = filteredMissingQuestions.length;

                if (totalQuestions > 0) {
                    currentQuestionIndex = 0;
                    preRenderedQuestions = filteredMissingQuestions;
                    findMissingBtn.disabled = true;
                    displayQuestion();
                } else {
                    questionContainer.innerHTML = '<p>No missing data questions found.</p>';
                    questionCount.textContent = '0 of 0';
                }

                updateGeneratedQueries();
            }
            
            function showFlaggedValuesQuestions() {
    console.log('Show Flagged Values button clicked');

    // Make an AJAX request to fetch flagged values questions
    fetch('/show_flagged_values_questions', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        const flaggedValuesQuestions = data.questions;

        // Update the question container with flagged values questions
        questionContainer.innerHTML = ''; // Clear existing content

        // Iterate through flagged values questions and append to the question container
        flaggedValuesQuestions.forEach(question => {
            const questionElement = document.createElement('p');
            questionElement.textContent = question;
            questionContainer.appendChild(questionElement);
        });

        // Hide other buttons on the flagged values page
        yesBtn.style.display = 'none';
        noBtn.style.display = 'none';
        backBtn.style.display = 'none';
        findMissingBtn.style.display = 'none';
        findMissingYesBtn.style.display = 'none';
        findMissingNoBtn.style.display = 'none';
        findMissingBackBtn.style.display = 'none';
        submitAnswerBtn.style.display = 'inline-block';
    })
    .catch(error => console.error(error));
}

            // Function to handle button clicks on the index page
            function handleIndexPageButtonClick(buttonId) {
                if (buttonId === 'yes') {
                    answerYes_index();
                } else if (buttonId === 'no') {
                    answerNo_index();
                } else if (buttonId === 'back') {
                    goBack_index();
                }
            }

            function handleFindMissingPageButtonClick(buttonId) {
            // Function for handling button clicks on the find_missing_values page
            if (buttonId === 'yes') {
                findMissingPageAnswerYes();
            } else if (buttonId === 'no') {
                findMissingPageAnswerNo();
            } else if (buttonId === 'back') {
                findMissingPageGoBack();
            }
        }
            
// Function to handle button click on the flagged values page
function handleFlaggedValuesButtonClick(buttonId) {
    if (buttonId === 'submit-answer') {
        console.log('Submitting flagged values answers');
    }
}

//Event listener for the 'Submit Answer' button on flagged values page
document.getElementById('submit-answer-btn').addEventListener('click', function () {
    console.log('Submit button clicked');
    handleFlaggedValuesButtonClick('submit-answer');
});

            // Event listener for the 'Show Flagged Values' button
            document.getElementById('show-flagged-values-btn').addEventListener('click', function() {
    fetch('/show_flagged_values_questions', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // Update to use the correct structure for the questions
        const flaggedValuesQuestions = data.questions.map(question => ({
            question: question.question, // Assuming 'question' contains the question text
            rule_violation: question.rule_violation, // Rule violation text
            name: `flagged_value_question_${question.row_id}`, // Unique identifier for each question
            row_id: question.row_id // Row ID if available
        }));

        // Update preRenderedQuestions with the new data
        preRenderedQuestions = flaggedValuesQuestions;
        // Reset the current question index and display the first question
        currentQuestionIndex = 0;
        displayQuestion();
    })
    .catch(error => console.error(error));

    // Hide other buttons and show necessary ones for flagged values questions
    yesBtn.style.display = 'none';
    noBtn.style.display = 'none';
    backBtn.style.display = 'none';
    findMissingBtn.style.display = 'none';
    findMissingYesBtn.style.display = 'none';
    findMissingNoBtn.style.display = 'none';
    findMissingBackBtn.style.display = 'none';
    flaggedValue.style.display = 'none';

    flaggedValuesnoBtn.style.display = 'inline-block';
    flaggedValuesbackBtn.style.display = 'inline-block';
    submitAnswerBtn.style.display = 'inline-block';
});

            // Event listeners for index page buttons
            document.getElementById('index-yes-btn').addEventListener('click', function () {
                handleIndexPageButtonClick('yes');
            });

            document.getElementById('index-no-btn').addEventListener('click', function () {
                handleIndexPageButtonClick('no');
            });

            document.getElementById('index-back-btn').addEventListener('click', function () {
                handleIndexPageButtonClick('back');
            });

            document.getElementById('show-flagged-values-no-btn').addEventListener('click', function () {
                currentQuestionIndex++;
                if (currentQuestionIndex < preRenderedQuestions.length) {
                    displayQuestion();
                } else {
                    alert('All questions answered.');
                }
            });
            
            document.getElementById('show-flagged-values-back-btn').addEventListener('click', function () {
                currentQuestionIndex--;
                if (currentQuestionIndex >= 0) {
                    displayQuestion();
                } else {
                    alert('No previous questions.');
                    currentQuestionIndex = 0; // Reset to the first question
                }
            });

            // Event listeners for find_missing_values page buttons
            findMissingYesBtn.addEventListener('click', function () {
                handleFindMissingPageButtonClick('yes');
            });

            findMissingNoBtn.addEventListener('click', function () {
                handleFindMissingPageButtonClick('no');
            });

            findMissingBackBtn.addEventListener('click', function () {
                handleFindMissingPageButtonClick('back');
            });

                if (totalQuestions > 0) {
                    displayQuestion();
                } else {
                    alert('No questions found.');
                }
        });
    </script>

</body>
</html>